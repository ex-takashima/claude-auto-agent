# CLAUDE.md - Claude Code Action 指示書

このファイルは Claude Code Action への指示を記述しています。

## プロジェクト概要

定期的にWebサイトをクロールし、新着情報を要約してDiscord/LINEに通知する自動エージェントです。

## ファイル構成

```
config/sources.json          # ソース設定（クロール対象URL、カテゴリ）
data/latest.json             # 差分検出用（通知済みURL一覧）
data/reports/                # リサーチ結果（Markdown形式）
.github/workflows/           # GitHub Actionsワークフロー
.github/ISSUE_TEMPLATE/      # Issueテンプレート
```

---

## タスク1: 定時リサーチ実行

### トリガー

- scheduled-task.yml の `collect-and-commit` ジョブから呼び出し
- `workflow_dispatch` での手動実行

### ワークフローから渡される情報

プロンプトに以下の情報が含まれます:
- **現在時刻**: JST形式 (例: `2026-01-09 07:00 JST`)
- **レポート日付**: JST日付 (例: `2026-01-09`)

これらの値をレポート生成時に使用してください。

### 処理手順

1. **設定読み込み**
   - `config/sources.json` を読み込む
   - `enabled: true` のソースのみ対象
   - カテゴリも `enabled: true` のもののみ

2. **差分検出**
   - `data/latest.json` を読み込む（なければ空として扱う）
   - `notified_urls` に含まれるURLは既に通知済み

3. **クロール実行**
   - 各ソースURLにアクセス
   - 記事一覧ページから最新記事のURLとタイトルを取得
   - `settings.max_items_per_source` 件まで取得

4. **記事の鮮度フィルタリング**
   - `settings.max_article_age_days` が設定されている場合、古い記事を除外
   - 現在日付から `max_article_age_days` 日以内に公開された記事のみ対象
   - 記事の公開日は、記事ページまたは一覧ページから判別する
   - 公開日が判別できない場合は対象に含める（安全側に倒す）

5. **新着判定**
   - `data/latest.json` の `notified_urls` にないURLが新着
   - 新着がなければ通知せず終了

6. **要約生成**
   - 新着記事の内容を取得
   - `settings.language` の言語で要約
   - `settings.summary_length` に応じた長さで要約
     - short: 1-2文
     - medium: 3-5文
     - long: 1段落

7. **レポート保存**
   - `data/reports/{レポート日付}.md` に保存（日付はプロンプトから取得）
   - 同日に複数回実行した場合は追記または上書き
   - フロントマター（YAML）に日付、カテゴリ、URL一覧を記録
   - 生成時刻にはプロンプトで指定された時刻を使用

8. **差分データ更新**
   - `data/latest.json` の `notified_urls` に新着URLを追加
   - `last_updated` を現在時刻に更新

### レポートのフォーマット

```markdown
---
date: YYYY-MM-DD
categories:
  - カテゴリID
sources_checked:
  - チェックしたURL
urls_found:
  - 発見した記事URL
---

# 📰 リサーチレポート (YYYY-MM-DD)

## カテゴリ名

### ソース名

- **記事タイトル**
  要約文...
  
  🔗 記事URL

---

⏰ 生成時刻: HH:MM JST
```

---

## タスク2: 通知メッセージ生成

### トリガー

- scheduled-task.yml の `notify` ジョブから呼び出し
- レポートファイルが存在する場合のみ実行

### 処理手順

1. **レポート読み込み**
   - プロンプトで指定されたレポートファイルを読み込む
   - 記事タイトルと要約を抽出

2. **通知メッセージ生成**
   - 記事タイトルを日本語に翻訳（英語の場合）
   - 各通知先に最適化したフォーマットで整形
   - 文字数制限を考慮（Discord: 2000文字、LINE: 5000文字）

3. **ファイルに保存**
   - Discord向け: `./discord_message.txt`（カレントディレクトリ直下）
   - LINE向け: `./line_message.txt`（カレントディレクトリ直下）
   - プレーンテキストで保存（JSONエスケープ不要）
   - **重要:** `/tmp/` は使用禁止（権限エラーになるため）

**注意:** 通知の送信はワークフローの別ステップで行われます。Claude Codeはメッセージ生成のみを担当します。

### Discord通知フォーマット

```
📰 AI最新ニュース (YYYY-MM-DD)
━━━━━━━━━━━━━━━━━━━━

🔹 ソース名
• 記事タイトル（日本語）

🔹 別のソース名
• 記事タイトル（日本語）

━━━━━━━━━━━━━━━━━━━━
📄 詳細: [GitHubリンク]
```

### LINE通知フォーマット

LINEはシンプルで読みやすい形式にする。装飾は最小限に。

```
📰 AI最新ニュース
YYYY-MM-DD

■ ソース名
・記事タイトル（日本語）

■ 別のソース名
・記事タイトル（日本語）

詳細: [GitHubリンク]
```

---

## タスク3: Issueコマンド処理

### トリガー

- issue-command.yml から呼び出し
- ラベル `command` が付与されたIssue

### Issueの解析

- **タイトル**: コマンド名
- **本文**: パラメータ（`key: value` 形式）

### 対応コマンド

#### `add source` - ソース追加

**パラメータ:**
- `url` (必須): クロール対象URL
- `name` (必須): 表示名
- `categories` (必須): カテゴリID（カンマ区切りで複数可）

**処理:**
1. `config/sources.json` を読み込む
2. URLから一意のIDを生成（ドメイン名ベース）
3. 重複チェック（同じURLが既にあればエラー）
4. `sources` 配列に追加
5. ファイルを保存
6. Issueにコメントで結果報告
7. Issueをクローズ

**成功時コメント:**
```
✅ ソースを追加しました

- **ID:** generated-id
- **名前:** ソース名
- **URL:** https://example.com
- **カテゴリ:** ai-news, tech-blog
```

#### `remove source` - ソース削除

**パラメータ:**
- `id` (必須): 削除するソースのID

**処理:**
1. `config/sources.json` を読み込む
2. 指定IDのソースを検索
3. 見つからなければエラー
4. `sources` 配列から削除
5. ファイルを保存
6. Issueにコメントで結果報告
7. Issueをクローズ

#### `list sources` - ソース一覧

**パラメータ:** なし

**処理:**
1. `config/sources.json` を読み込む
2. ソース一覧をMarkdown形式で整形
3. Issueにコメントで一覧を投稿
4. Issueをクローズ

**コメント形式:**
```
📋 登録済みソース一覧

| ID | 名前 | URL | カテゴリ | 状態 |
|----|------|-----|---------|------|
| anthropic | Anthropic公式 | https://... | ai-news, llm | ✅ 有効 |
| openai | OpenAI公式 | https://... | ai-news | ❌ 無効 |
```

#### `enable source` / `disable source` - 有効/無効切り替え

**パラメータ:**
- `id` (必須): ソースのID

**処理:**
1. `config/sources.json` を読み込む
2. 指定IDのソースを検索
3. `enabled` を `true` / `false` に変更
4. ファイルを保存
5. Issueにコメントで結果報告
6. Issueをクローズ

#### `add category` - カテゴリ追加

**パラメータ:**
- `id` (必須): カテゴリID（英数字、ハイフン）
- `name` (必須): 表示名
- `description` (任意): 説明

**処理:**
1. `config/sources.json` を読み込む
2. 重複チェック
3. `categories` オブジェクトに追加（`enabled: true`）
4. ファイルを保存
5. Issueにコメントで結果報告
6. Issueをクローズ

#### `remove category` - カテゴリ削除

**パラメータ:**
- `id` (必須): カテゴリID

**処理:**
1. `config/sources.json` を読み込む
2. 指定IDのカテゴリを検索
3. そのカテゴリを使用しているソースがあれば警告
4. `categories` から削除
5. ファイルを保存
6. Issueにコメントで結果報告
7. Issueをクローズ

#### `run now` - 即時実行

**パラメータ:**
- `category` (任意): 特定カテゴリのみ実行

**処理:**
1. タスク1（定時リサーチ実行）と同じ処理を実行
2. `category` 指定があればそのカテゴリのみ
3. Issueにコメントで結果報告
4. Issueをクローズ

#### `ask: ...` - 自由な相談・リサーチ依頼

**概要:**
タイトルが「ask:」で始まるIssueは、自由形式の相談やリサーチ依頼として処理します。

**本文の構成:**
- `依頼内容`: 自由記述のリサーチ・作業依頼
- `実行権限`: 「リサーチのみ」または「設定変更OK」

**処理:**
1. 「依頼内容」に従ってリサーチや作業を実行
2. 「実行権限」が「リサーチのみ」の場合は設定変更せず報告のみ
3. 「設定変更OK」の場合はソース/カテゴリの追加・変更を**必ず実行する**
   - **重要:** 報告だけでなく、`config/sources.json` を実際に編集すること
   - Edit ツールを使って設定ファイルを更新する
   - 「追加しました」と報告する前に、必ずファイル編集を完了させる
4. 結果は詳細にIssueコメントで報告
5. Issueをクローズ

**依頼例:**
- 「SUNO AI関連のニュースをキャッチできるソースを探して、見つかったら追加して」
- 「OpenAIの公式ブログをソースに追加したい。URLを調べて設定して」
- 「現在のソース設定を見直して、重複や問題がないか確認して」

### エラー処理

- パラメータ不足: 必要なパラメータを案内
- ID重複: 既存のIDを表示
- ID不明: 利用可能なIDを一覧表示
- その他エラー: エラー内容を報告

**エラー時コメント:**
```
❌ エラーが発生しました

**原因:** 指定されたID `xxx` が見つかりません

**利用可能なID:**
- anthropic
- openai
- deepmind
```

---

## 環境変数

以下の環境変数を使用します（GitHub Secretsから取得）:

| 変数名 | 用途 | 必須 |
|--------|------|------|
| `DISCORD_WEBHOOK_URL` | Discord通知 | 任意 |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE通知 | 任意 |
| `LINE_USER_ID` | LINE通知先 | 任意 |

---

## 注意事項

1. **JSONファイルの整形**: 保存時は2スペースインデントで整形する
2. **日本時間**: 日付・時刻は JST (UTC+9) で表示。定時タスクではワークフローからJST時刻が渡されるので、その値を使用すること
3. **コミット**: 変更があればコミットする（コミットメッセージは処理内容を簡潔に）
4. **レート制限**: クロール時は各サイトに負荷をかけないよう適度な間隔を空ける
5. **エラーハンドリング**: サイトにアクセスできない場合はスキップし、他のソースの処理を継続
