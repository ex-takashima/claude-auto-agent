name: Scheduled Task

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = JST 07:00
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œç”¨

permissions:
  contents: write
  id-token: write

jobs:
  collect-and-notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            å®šæ™‚ãƒªã‚µãƒ¼ãƒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

            1. config/sources.json ã‚’èª­ã¿è¾¼ã¿ã€æœ‰åŠ¹ãªã‚½ãƒ¼ã‚¹ï¼ˆenabled: trueï¼‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
            2. data/latest.json ã§å·®åˆ†æ¤œå‡ºï¼ˆæ–°ç€è¨˜äº‹ã®ã¿å¯¾è±¡ï¼‰
            3. æ–°ç€è¨˜äº‹ãŒã‚ã‚Œã°è¦ç´„ã‚’ç”Ÿæˆ
            4. data/reports/YYYY-MM-DD.md ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
            5. data/latest.json ã‚’æ›´æ–°

            CLAUDE.md ã®æŒ‡ç¤ºã«å¾“ã£ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            æ³¨æ„ï¼šDiscord/LINEé€šçŸ¥ã¯åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€šçŸ¥ã‚’é€ã‚‰ãªã„ã§ãã ã•ã„ã€‚
          allowed_tools: "Bash(*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update crawled data [$(date +'%Y-%m-%d')]"
          git push

      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        run: |
          REPORT_FILE="data/reports/$(date +'%Y-%m-%d').md"
          if [ -f "$REPORT_FILE" ]; then
            REPO_URL="https://github.com/${{ github.repository }}"
            DATE=$(date +'%Y-%m-%d')

            # JSON payload with proper escaping
            PAYLOAD=$(cat <<EOF
{
  "content": "ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ ($DATE)\n\næ–°ç€è¨˜äº‹ã®ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚\n\nğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆ: $REPO_URL/blob/main/$REPORT_FILE"
}
EOF
)

            curl -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK_URL"

            echo "Discord notification sent successfully"
          else
            echo "No report found for today"
          fi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
