name: Scheduled Task

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = JST 07:00
  workflow_dispatch:       # 手動実行用

permissions:
  contents: write
  id-token: write

jobs:
  # ジョブ1: Claude Codeでクロール・レポート生成・コミット
  collect-and-commit:
    runs-on: ubuntu-latest
    outputs:
      has_report: ${{ steps.check.outputs.has_report }}
      report_date: ${{ steps.check.outputs.report_date }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            定時リサーチタスクを実行してください。

            1. config/sources.json を読み込み、有効なソース（enabled: true）をクロール
            2. data/latest.json で差分検出（新着記事のみ対象）
            3. 新着記事があれば要約を生成
            4. data/reports/YYYY-MM-DD.md にレポートを保存
            5. data/latest.json を更新

            CLAUDE.md の「タスク1: 定時リサーチ実行」に従って実行してください。
            注意：Discord/LINE通知は別ジョブで実行されるため、ここでは通知を送らないでください。
          allowed_tools: "Bash(*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update crawled data [$(date +'%Y-%m-%d')]"
          git push

      - name: Check for report
        id: check
        run: |
          REPORT_DATE=$(date +'%Y-%m-%d')
          REPORT_FILE="data/reports/${REPORT_DATE}.md"
          if [ -f "$REPORT_FILE" ]; then
            echo "has_report=true" >> $GITHUB_OUTPUT
          else
            echo "has_report=false" >> $GITHUB_OUTPUT
          fi
          echo "report_date=${REPORT_DATE}" >> $GITHUB_OUTPUT

  # ジョブ2: Claude Codeで通知メッセージ生成・送信
  notify:
    needs: collect-and-commit
    if: needs.collect-and-commit.outputs.has_report == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # 最新のコミットを取得

      - name: Generate and send notifications
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            通知メッセージ生成・送信タスクを実行してください。

            レポートファイル: data/reports/${{ needs.collect-and-commit.outputs.report_date }}.md
            リポジトリURL: https://github.com/${{ github.repository }}

            CLAUDE.md の「タスク2: 通知メッセージ生成・送信」に従って実行してください。

            処理手順：
            1. レポートファイルを読み込む
            2. 記事タイトルを日本語に翻訳（英語の場合）
            3. Discord向けメッセージを生成して送信（$DISCORD_WEBHOOK_URL が設定されている場合）
            4. LINE向けメッセージを生成して送信（$LINE_CHANNEL_ACCESS_TOKEN と $LINE_USER_ID が設定されている場合）

            重要：
            - 記事タイトルは必ず日本語で表示
            - 改行は正しく処理されるようにJSONエスケープを行う
            - LINEメッセージはシンプルで読みやすい形式に
          allowed_tools: "Bash(*),Read,Glob,Grep"
          claude_env: |
            DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
            LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
            LINE_USER_ID=${{ secrets.LINE_USER_ID }}
