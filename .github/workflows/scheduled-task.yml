name: Scheduled Task

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = JST 07:00
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œç”¨

permissions:
  contents: write
  id-token: write

jobs:
  # ã‚¸ãƒ§ãƒ–1: Claude Codeã§ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»ã‚³ãƒŸãƒƒãƒˆ
  collect-and-commit:
    runs-on: ubuntu-latest
    outputs:
      has_report: ${{ steps.check.outputs.has_report }}
      report_date: ${{ steps.check.outputs.report_date }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            å®šæ™‚ãƒªã‚µãƒ¼ãƒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

            1. config/sources.json ã‚’èª­ã¿è¾¼ã¿ã€æœ‰åŠ¹ãªã‚½ãƒ¼ã‚¹ï¼ˆenabled: trueï¼‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
            2. data/latest.json ã§å·®åˆ†æ¤œå‡ºï¼ˆæ–°ç€è¨˜äº‹ã®ã¿å¯¾è±¡ï¼‰
            3. æ–°ç€è¨˜äº‹ãŒã‚ã‚Œã°è¦ç´„ã‚’ç”Ÿæˆ
            4. data/reports/YYYY-MM-DD.md ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
            5. data/latest.json ã‚’æ›´æ–°

            CLAUDE.md ã®ã€Œã‚¿ã‚¹ã‚¯1: å®šæ™‚ãƒªã‚µãƒ¼ãƒå®Ÿè¡Œã€ã«å¾“ã£ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            æ³¨æ„ï¼šDiscord/LINEé€šçŸ¥ã¯åˆ¥ã‚¸ãƒ§ãƒ–ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€šçŸ¥ã‚’é€ã‚‰ãªã„ã§ãã ã•ã„ã€‚
          allowed_tools: "Bash(*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update crawled data [$(date +'%Y-%m-%d')]"
          git push

      - name: Check for report
        id: check
        run: |
          REPORT_DATE=$(date +'%Y-%m-%d')
          REPORT_FILE="data/reports/${REPORT_DATE}.md"
          if [ -f "$REPORT_FILE" ]; then
            echo "has_report=true" >> $GITHUB_OUTPUT
          else
            echo "has_report=false" >> $GITHUB_OUTPUT
          fi
          echo "report_date=${REPORT_DATE}" >> $GITHUB_OUTPUT

  # ã‚¸ãƒ§ãƒ–2: é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒ»é€ä¿¡
  notify:
    needs: collect-and-commit
    if: needs.collect-and-commit.outputs.has_report == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate notification messages with Claude Code
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚

            ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: data/reports/${{ needs.collect-and-commit.outputs.report_date }}.md
            ãƒªãƒã‚¸ãƒˆãƒªURL: https://github.com/${{ github.repository }}

            å‡¦ç†æ‰‹é †ï¼š
            1. ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            2. è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ—¥æœ¬èªã«ç¿»è¨³ï¼ˆè‹±èªã®å ´åˆï¼‰
            3. Discordå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ /tmp/discord_message.txt ã«ä¿å­˜
            4. LINEå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ /tmp/line_message.txt ã«ä¿å­˜

            Discordå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
            ```
            ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ (YYYY-MM-DD)
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

            ğŸ”¹ ã‚½ãƒ¼ã‚¹å
            â€¢ è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªè¨³ï¼‰

            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“„ è©³ç´°: [ãƒªãƒã‚¸ãƒˆãƒªURL]/blob/main/data/reports/[æ—¥ä»˜].md
            ```

            LINEå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰:
            ```
            ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹
            YYYY-MM-DD

            â–  ã‚½ãƒ¼ã‚¹å
            ãƒ»è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªè¨³ï¼‰

            è©³ç´°: [ãƒªãƒã‚¸ãƒˆãƒªURL]/blob/main/data/reports/[æ—¥ä»˜].md
            ```

            é‡è¦ï¼š
            - è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…ãšæ—¥æœ¬èªã§è¡¨ç¤ºã™ã‚‹ã“ã¨
            - ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜ï¼ˆJSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ä¸è¦ï¼‰
            - ç’°å¢ƒå¤‰æ•°ã¯å‚ç…§ã—ãªã„ã“ã¨
          allowed_tools: "Bash(mkdir:*,touch:*,cat:*),Read,Write,Glob,Grep"

      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        run: |
          if [ -f /tmp/discord_message.txt ]; then
            MESSAGE=$(cat /tmp/discord_message.txt)
            # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            MESSAGE_JSON=$(echo "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"content\":${MESSAGE_JSON}}" \
              "$DISCORD_WEBHOOK_URL"

            echo "Discord notification sent"
          else
            echo "Discord message file not found"
          fi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send LINE notification
        if: env.LINE_CHANNEL_ACCESS_TOKEN != '' && env.LINE_USER_ID != ''
        run: |
          if [ -f /tmp/line_message.txt ]; then
            MESSAGE=$(cat /tmp/line_message.txt)
            # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            MESSAGE_JSON=$(echo "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

            curl -X POST https://api.line.me/v2/bot/message/push \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN" \
              -d "{\"to\":\"$LINE_USER_ID\",\"messages\":[{\"type\":\"text\",\"text\":$MESSAGE_JSON}]}"

            echo "LINE notification sent"
          else
            echo "LINE message file not found"
          fi
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
