name: Scheduled Task

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = JST 07:00
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œç”¨

permissions:
  contents: write
  id-token: write

jobs:
  collect-and-notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            å®šæ™‚ãƒªã‚µãƒ¼ãƒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

            1. config/sources.json ã‚’èª­ã¿è¾¼ã¿ã€æœ‰åŠ¹ãªã‚½ãƒ¼ã‚¹ï¼ˆenabled: trueï¼‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
            2. data/latest.json ã§å·®åˆ†æ¤œå‡ºï¼ˆæ–°ç€è¨˜äº‹ã®ã¿å¯¾è±¡ï¼‰
            3. æ–°ç€è¨˜äº‹ãŒã‚ã‚Œã°è¦ç´„ã‚’ç”Ÿæˆ
            4. data/reports/YYYY-MM-DD.md ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
            5. data/latest.json ã‚’æ›´æ–°

            CLAUDE.md ã®æŒ‡ç¤ºã«å¾“ã£ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            æ³¨æ„ï¼šDiscord/LINEé€šçŸ¥ã¯åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€šçŸ¥ã‚’é€ã‚‰ãªã„ã§ãã ã•ã„ã€‚
          allowed_tools: "Bash(*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update crawled data [$(date +'%Y-%m-%d')]"
          git push

      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        run: |
          REPORT_FILE="data/reports/$(date +'%Y-%m-%d').md"
          if [ -f "$REPORT_FILE" ]; then
            REPO_URL="https://github.com/${{ github.repository }}"
            DATE=$(date +'%Y-%m-%d')

            # ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºï¼ˆæœ€åˆã®20ä»¶ã¾ã§ï¼‰
            TITLES=$(grep -E "^- \*\*" "$REPORT_FILE" | head -20 | sed 's/- \*\*/â€¢ /' | sed 's/\*\*//')

            # è¨˜äº‹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            ARTICLE_COUNT=$(grep -c "^- \*\*" "$REPORT_FILE" || echo "0")

            MESSAGE="ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ ($DATE)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\næ–°ç€è¨˜äº‹: ${ARTICLE_COUNT}ä»¶\\n\\n$TITLES\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: $REPO_URL/blob/main/$REPORT_FILE"

            curl -H "Content-Type: application/json" \
              -d "{\"content\":\"$MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"

            echo "Discord notification sent successfully"
          else
            echo "No report found for today"
          fi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send LINE notification
        if: env.LINE_CHANNEL_ACCESS_TOKEN != '' && env.LINE_USER_ID != ''
        run: |
          REPORT_FILE="data/reports/$(date +'%Y-%m-%d').md"
          if [ -f "$REPORT_FILE" ]; then
            REPO_URL="https://github.com/${{ github.repository }}"
            DATE=$(date +'%Y-%m-%d')

            # ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºï¼ˆæœ€åˆã®10ä»¶ã¾ã§ï¼‰
            TITLES=$(grep -E "^- \*\*" "$REPORT_FILE" | head -10 | sed 's/- \*\*/â€¢ /' | sed 's/\*\*//')

            # è¨˜äº‹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            ARTICLE_COUNT=$(grep -c "^- \*\*" "$REPORT_FILE" || echo "0")

            MESSAGE="ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ ($DATE)\n\næ–°ç€è¨˜äº‹: ${ARTICLE_COUNT}ä»¶\n\n$TITLES\n\nğŸ“„ è©³ç´°: $REPO_URL/blob/main/$REPORT_FILE"

            # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            MESSAGE_JSON=$(echo "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

            curl -X POST https://api.line.me/v2/bot/message/push \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN" \
              -d "{\"to\":\"$LINE_USER_ID\",\"messages\":[{\"type\":\"text\",\"text\":$MESSAGE_JSON}]}"

            echo "LINE notification sent successfully"
          else
            echo "No report found for today"
          fi
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
